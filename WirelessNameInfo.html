<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <link rel="stylesheet" href="css/bootstrap/3.3.7/bootstrap.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap/3.3.7/bootstrap.min.js"></script>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <link href="css/style.css?mv=20210527" rel="stylesheet" />
    <script type="text/javascript" src="js/common.js?mv=20210527"></script>
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0
        }
        
        .Path-101 {
            width: 114px;
            height: 50px;
            border: solid 1px #707070;
            background-color: #f1f1f1;
            border-radius: 5px;
        }
        
        .Path-101:hover {
            background-color: #009fe3;
            color: #fff;
        }
        /* .Rectangle-1187 {
            width: 534px;
            height: 347px;
            border: solid 1px #707070;
            background-color: #ffffff;
        } */
        /* .Rectangle-1182 {
        width: 124px;
        height: 50px;
        border-radius: 5px;
        background-color: #009fe3;
        background-color: #f1f1f1;
    } */
        
        .Rectangle-1182:hover {
            background-color: #009fe3;
            color: #fff;
        }
        
        .Rectangle-1182.active {
            background-color: #009fe3;
        }
        
        .Cancel {
            /* width: 62px;
  height: 27px; */
            font-family: OpenSans;
            font-size: 20px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.45;
            letter-spacing: normal;
            text-align: center;
            color: #343434;
        }
        
        .OK {
            /* width: 28px;
            height: 27px; */
            font-family: OpenSans;
            font-size: 20px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.35;
            letter-spacing: normal;
            text-align: center;
            color: #ffffff;
        }
        
        #enterPass,
        #enterPass1 {
            /* position: absolute;
            top: 50%;
            left: 50%; */
            width: 500px;
            height: 318px;
            /* margin-left: -250px;
            margin-top: -152px; */
            padding: 40px;
            z-index: 999999;
            border-radius: 5px;
        }
        
        .Password-is-incorrect {
            font-family: OpenSans;
            font-size: 18px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.33;
            letter-spacing: normal;
            text-align: left;
            color: #ff002a;
            margin-left: 90px;
            margin-top: 10px;
        }
        
        .Rectangle-1185 {
            width: 235px;
            height: 32px;
            border-radius: 5px;
            border: solid 1px #707070;
            padding: 5px 10px;
        }
        
        .Enter-the-password-for-network-Mynetwork1 {
            font-family: OpenSans;
            font-size: 24px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.42;
            letter-spacing: normal;
            text-align: left;
            color: #343434;
        }
        
        .Password {
            /* width: 86px; */
            height: 24px;
            font-family: OpenSans;
            font-size: 18px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.61;
            letter-spacing: normal;
            text-align: left;
            color: #343434;
            margin-left: 15px;
        }
        
        .SHOW {
            font-family: OpenSans;
            font-size: 12px;
            font-weight: bold;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.42;
            letter-spacing: normal;
            text-align: left;
            color: #009fe3;
            margin-left: -66px;
        }
        
        .Rectangle-1188 {
            width: 344px;
            height: 40px;
            border-radius: 5px;
            border: solid 1px #707070;
            background-color: #ffffff;
        }
        
        .Rectangle-1187 {
            width: 500px;
            height: 440px;
            border-radius: 5px;
            /* border: solid 1px #707070; */
            background-color: #ffffff;
        }
        
        .Rectangle-1182 {
            width: 71.8px;
            height: 42px;
            /* padding: 0 20px; */
            border-radius: 5px;
            background-color: #009fe3;
            color: #fff;
            padding: 0;
        }
        
        .Forget-network {
            width: 71.8px;
            height: 42px;
            /* padding: 0 20px; */
            border-radius: 5px;
            background-color: #009fe3;
            color: #fff;
            padding: 0 10px;
        }
        
        #pwd {
            padding: 5px 10px
        }
        
        .error {
            color: #f00;
            display: none;
            margin: 10px 0 10px 104px;
            font-weight: bold;
            /* visibility: hidden; */
            /* height: 30px; */
        }
        
        .correct {
            display: none;
            color: green;
            margin: 10px 0 10px 104px;
            font-weight: bold;
            /* visibility: hidden; */
            /* height: 30px; */
        }
        
        .SKY546H {
            height: 33px;
            font-family: OpenSans;
            font-size: 24px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.08;
            letter-spacing: normal;
            text-align: left;
            color: #343434;
            padding-left: 16px;
            margin-bottom: 12px;
        }
        
        .wirelessInfo {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }
        
        .layui-form-label {
            width: 270px !important;
        }
        
        .form-control-static {
            padding-top: 12px;
        }
        
        .Status {
            font-family: OpenSans;
            font-size: 18px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.61;
            letter-spacing: normal;
            text-align: left;
            color: #343434;
        }
        
        .Connected {
            font-family: OpenSans;
            font-size: 18px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.61;
            letter-spacing: normal;
            text-align: left;
            color: #343434;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .layui-form-switch {
            margin-top: 12px;
        }
        
        .Path-97 {
            width: 138.9px;
            height: 42px;
            border-radius: 5px;
            border: solid 1px #707070;
            background-color: #f1f1f1;
        }
        
        .Close {
            font-family: OpenSans;
            font-size: 16px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.38;
            letter-spacing: normal;
            text-align: center;
            color: #f9f9f9;
        }
        
        .bottom-btn {
            text-align: right;
            margin-right: 0px;
        }
        
        .layui-form {
            position: relative;
        }
        
        .card-close {
            width: 12px;
            position: absolute;
            top: 0;
            right: 15px;
            color: #666;
        }
        
        .WLAN-auto-swtich {
            display: none;
        }
        
        .layui-form-item {
            margin-bottom: 0;
        }
        
        .layui-layer-iframe {
            overflow: hidden !important;
            overflow-y: hidden !important;
        }
        
        html,
        body {
            height: 100%;
        }
        
        .btn-bottom {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <div class="container wirelessInfo form-inline" id="wirelessInfo">
        <div class="layui-form">
            <div class="SKY546H">--</div>
            <img src="images/close.png" class="card-close card-close-btn" />
            <div class="layui-form-item">
                <label class="layui-form-label Status">Status:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Connected-Status">--</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Signal strength:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Signal-strength" id="Signal_strength">--</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Link speed:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Link-speed">--Mbps</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Frequency band:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Frequency-band">--GHz</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Channel:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Channel">--</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Security:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected Security">--</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">MAC address:</label>
                <div class="layui-input-block">
                    <p class="form-control-static Connected MAC-address">--</p>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Status">Connect automatically:</label>
                <div class="layui-input-block WLAN-auto-swtich">
                    <input id="WLAN_auto_swtich" type="checkbox" name="open" lay-skin="switch" lay-filter="switchTest" lay-text="ON|OFF">
                    <div class="layui-unselect layui-form-switch layui-form-onswitch" lay-skin="_switch">
                        <em>ON</em><i></i></div>
                </div>
            </div>
            <div class="btn-bottom mt-20 mb-20">
                <!-- <button id="layerDemo" data-method="notice" class="Path-97 layui-btn Forget-network" disabled>Forget
                    network</button> -->
                <button id="layerDemo" class="Forget-network active ml-20" style="width:auto;">Forget
                    network</button>
            </div>
        </div>
    </div>
    <script src="layui/layui.js " charset="utf-8 "></script>
    <script type="text/javascript" src="js/common.js?mv=20210527"></script>
    <script>
        var ssid, bssid, encrypt, is_saved;
        $(function() {
            ssid = GetUrlParam("ssid");
            ssid = unescape(ssid);
            bssid = GetUrlParam("bssid");
            bssid = bssid != "undefined" ? bssid : "";
            console.log("bssid", bssid)
            encrypt = GetUrlParam("bssid");
            is_saved = GetUrlParam("is_saved");
            layui.use(['layer', 'form'], function() {
                var form = layui.form,
                    layer = layui.layer;
                getWifiDetail(layer, form);
                form.on('switch(switchTest)', function(data) {
                    var checked = data.elem.checked;
                    console.log(checked)
                    changeSwitchStatus(layer, form, checked)
                });
            });

            $('.card-close-btn').click(function() {
                $(parent.frames["my-iframe"].document).find("#saved_id").val("").attr("bssid", "");
                setTimeout(() => {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index); //关闭当前页
                }, 200);

            });

            $('#layerDemo').on('click', function() {
                //iframe层
                var missid = escape(ssid);
                parent.layer.open({
                    id: "forget",
                    type: 2,
                    title: false,
                    closeBtn: 0,
                    shade: 0.8,
                    area: ['534px', '260px'],
                    //area: '534px',
                    content: ['ForgetNetwork.html?ssid=' + missid + "&bssid=" + bssid +
                        "&is_saved=" + is_saved, 'no'
                    ],
                    end: function() {
                        var flag = $(parent.frames["my-iframe"].document).find(
                            "#wifiDetai_info").val();
                        console.log(flag)
                        if (!flag) {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index); //关闭当前页
                        }

                    }
                });
                $(window).resize();
            });
        })

        function getWifiDetail(layer, form) {
            var loading = layer.load(0, {
                shade: false
            });
            var data = {
                "jsonrpc": "2.0",
                "method": "WlanStationConfig",
                "params": {
                    "operate_code": 5,
                    "ssid": ssid,
                    "bssid": bssid ? bssid : "",
                },
                "id": "9.1"
            };

            data = JSON.stringify(data);
            $.ajax({
                type: "post",
                timeout: 7000,
                url: "/action/action",
                data: data,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function(res) {
                    layer.close(loading);
                    $("#layerDemo").removeAttr("disabled");
                    if (res.result) {
                        if (res.result.status == "Unexpected Error Occured!") {
                            getWifiDetail(layer, form);
                        }
                        $(".SKY546H").text(res.result.ssid);
                        $(".Link-speed").text(res.result.rate + "Mbps");
                        $(".Security").text(res.result.encrypt);
                        $(".Security").attr("title", res.result.encrypt);
                        $(".MAC-address").text(res.result.bssid);
                        $(".Connected-Status").text(res.result.status);
                        if (res.result.is_saved == 0) {
                            $('#layerDemo').hide();
                        }
                        var signal = Math.abs(res.result.rssi);
                        console.log(signal)
                        if (signal < 70) {
                            console.log(11)
                            $("#Signal_strength").text("Good");
                        } else if (signal >= 70) {
                            console.log(22)
                            $("#Signal_strength").text("Weak");
                        }
                        var Channel;
                        if (2400 < res.result.freq && res.result.freq < 2900) {
                            $(".Frequency-band").text("2.4GHz");
                            Channel = freq2Gchannel(res.result.freq);
                            $(".Channel").text(Channel);
                        } else if (5030 < res.result.freq && res.result.freq < 5900) {
                            $(".Frequency-band").text("5GHz");
                            Channel = freq5Gchannel(res.result.freq);
                            console.log("Channel", Channel)
                            $(".Channel").text(Channel);
                        }

                        if (res.result.auto_connect == 1) {
                            $("#WLAN_auto_swtich").attr("checked", "checked");
                        } else {
                            $("#WLAN_auto_swtich").removeAttr("checked");
                        }
                        form.render();
                        $(".WLAN-auto-swtich").show();
                    } else if (res.error) {
                        layui.use(['form', 'layer'], function() {
                            var layer = layui.layer;
                            layer.msg("An error occurred：" + res.error.message);
                        })

                    }
                },
                complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
                    if (status == 'timeout') { //超时,status还有success,error等值的情况
                        ajaxTimeout.abort();
                        layui.use(['layer'], function() {
                            var layer = layui.layer;
                            layer.msg("request timeout")
                        });
                        $(parent.frames["my-iframe"].document).find("#saved_id").val("").attr("bssid", "");
                        setTimeout(() => {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index); //关闭当前页
                        }, 500);
                    }
                },
                error: function(jqXHR) {
                    layer.close(loading);
                    console.log("Error message", JSON.stringify(jqXHR))
                    parent.layer.close(loading);
                    var tip =
                        '<div style="padding: 20px;text-align: center;word-wrap:break-word;">Abnormal communication, please try again later!</div>';
                    promptMessage("Error message", tip);
                }
            });
        }

        function changeSwitchStatus(layer, form, checked) {
            var mode;
            if (checked == false) {
                mode = 7;
            } else if (checked == true) {
                mode = 6;
            }
            var data = {
                "jsonrpc": "2.0",
                "method": "WlanStationConfig",
                "params": {
                    "operate_code": mode,
                    "ssid": ssid,
                    "bssid": bssid ? bssid : "",
                    "encrypt": encrypt,
                },
                "id": "9.1"
            };

            data = JSON.stringify(data);
            $.ajax({
                type: "post",
                url: "/action/action",
                data: data,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function(res) {
                    console.log("res", res)
                    if (res.result) {
                        //layer.msg(res.result.status);
                    } else if (res.error) {
                        layer.msg("An error occurred：" + res.error.message);
                    }


                },
                error: function(jqXHR) {
                    console.log("Error message", JSON.stringify(jqXHR))
                    parent.layer.close(loading);
                    var tip =
                        '<div style="padding: 20px;text-align: center;word-wrap:break-word;">Abnormal communication, please try again later!</div>';
                    promptMessage("Error message", tip);
                }
            });
        }
        //2G转channel
        function freq2Gchannel(freq) {
            var channel = (freq - 2412) / 5 + 1;
            return channel;
        }
        //5G转channel
        function freq5Gchannel(freq) {
            var channel;
            if (5035 <= freq && freq <= 5080) {
                switch (freq) {
                    case 5035:
                        channel = 7;
                        break;
                    case 5040:
                        channel = 8;
                        break;
                    case 5045:
                        channel = 9;
                        break;
                    case 5055:
                        channel = 11;
                        break;
                    case 5060:
                        channel = 12;
                        break;
                    case 5080:
                        channel = 16;
                        break;
                }
            } else if (5170 <= freq && freq <= 5320) {
                channel = (freq - 5170) / 10 * 2 + 34;
            } else if (5500 <= freq && freq <= 5640) {
                channel = (freq - 5500) / 10 * 2 + 100;
            } else if (5660 <= freq && freq <= 5720) {
                channel = (freq - 5660) / 10 * 2 + 132;
            } else if (5745 <= freq && freq <= 5805) {
                channel = (freq - 5745) / 10 * 2 + 149;
            } else if (5825 == freq) {
                channel = 165;
            } else if (4915 <= freq && freq <= 4925) {
                channel = (freq - 4915) / 5 + 183;
            } else if (4935 <= freq && freq <= 4945) {
                channel = (freq - 4935) / 5 + 187;
            } else if (4960 == freq) {
                channel = 192;
            } else if (4980 == freq) {
                channel = 196;
            }
            return channel;
        }
    </script>
</body>

</html>