<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> -->
    <title>OpenWrt - Flashing...</title>
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript">
        $(function() {
            var interval = window.setInterval(function() {
                var domain = window.location.host;
                var data = {
                    "jsonrpc": "2.0",
                    "method": "upgrade_status",
                    "params": {},
                    "id": "9.1"

                };
                data = JSON.stringify(data);
                $.ajax({
                    type: "post",
                    url: "/action/action?",
                    data: data,
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(data) {
                        console.log(data.result);
                        //$("#status").html(data.result.status);
                        $("#steps").html(data.result.steps)
                        var data = data.result;
                        if (data.status == "1") {
                            alert("Update Successful！");
                            console.log("Now the status is：" + data.status + "--Upgrade Complete...");
                            var ds = "Now the status is：" + data.status + "--Upgrade Complete...";
                            //alert(ds);
                            $("#steps").html(ds);
                            setTimeout(function() {
                                top.location.href = ('https:' == document.location.protocol ? 'https://' : 'http://') + domain;
                            }, 10000);

                            //top.location.href = ('https:' == document.location.protocol ? 'https://' : 'http://') + '10.88.11.238/';
                        } else if (data.status == "0") {
                            self.location.href = ('https:' == document.location.protocol ? 'https://' : 'http://') + domain + 'flashops.html';
                        } else {
                            console.log("Now the status is：" + data.status + "--Upgrading in progress...");
                            //console.log("Preparing system upgrade environment");
                            //console.log(data.steps);
                        }

                    },
                    // error: function(jqXHR) {
                    //     alert("An error occurred：" + jqXHR.status);
                    // }


                });
            }, 2000);
        });
    </script>
</head>

<body>
    <div id="mainContainer" style="margin-left:20px;">
        <div id="mainContent">
            <h2><a id="content" name="content">System - Flashing...</a></h2>
            <p id="status"></p>
            <p id="steps"></p>
            <fieldset class="cbi-section">
                <p>
                    The system is flashing now.<br /> DO NOT POWER OFF THE DEVICE!<br /> Wait a few minutes before you try to reconnect. It might be necessary to renew the address of your computer to reach the device again, depending on your settings.
                </p>
                <p>
                    <img src="images/loading.gif" alt="Loading" style="vertical-align:middle" /> Waiting for changes to be applied...
                </p>
            </fieldset>
        </div>
    </div>
</body>

</html>