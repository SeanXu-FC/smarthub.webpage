<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> -->
    <title>OpenWrt - Flashing...</title>
    <style>

    </style>
    <script src="js/jquery.min.js"></script>
    <script src="layui/layui.js " charset="utf-8 "></script>
    <script type="text/javascript">
        $(function() {
            layui.use(['form', 'layer'], function() {
                var form = layui.form;
                var layer = layui.layer;
                var loading = parent.layer.msg('Waiting for changes to be applied...', {
                    icon: 16,
                    time: false,
                    shade: [0.5, '#fff']
                });


                $(".layui-layer-loading .layui-layer-content").after("Waiting for changes to be applied...")
                var interval = window.setInterval(function() {
                    var domain = window.location.host;
                    var data = {
                        "jsonrpc": "2.0",
                        "method": "GetUpgradeStatus",
                        "params": {},
                        "id": "9.1"

                    };
                    data = JSON.stringify(data);
                    $.ajax({
                        type: "post",
                        url: "/action/action?",
                        data: data,
                        dataType: "json",
                        contentType: "application/json;charset=utf-8",
                        success: function(res) {

                            var data = res.result;
                            if (data.status == "1") { //升级成功
                                parent.layer.close(loading);
                                var ds = "Now the status is：" + data.status + "--Upgrade Complete...";
                                $("#steps").html(ds);
                                $("#upgrade_tip").hide();
                                setTimeout(function() {
                                    top.location.href = ('https:' == document.location.protocol ? 'https://' : 'http://') + domain;
                                }, 8000);
                                clearInterval(interval);
                            } else if (data.status == "0") { //升级失败
                                parent.layer.close(loading);
                                $("#steps").html(data.steps);
                                $("#steps").css("color", "red")
                                $("#upgrade_tip").hide();
                                setTimeout(function() {
                                    self.location.href = ('https:' == document.location.protocol ? 'https://' : 'http://') + domain + '/SoftwareUpgrade.html';
                                }, 5000);
                            } else if (data.status == "2") { //升级中
                                $("#steps").html(data.steps);
                            } else { //没有升级
                                parent.layer.close(loading);
                                $("#steps").html(data.steps);
                                $("#upgrade_tip").hide();
                                clearInterval(interval);
                            }

                        },
                        error: function(jqXHR) {
                            parent.layer.close(loading);
                            var tip = '<div style="padding: 20px;text-align: center;word-wrap:break-word;">' + JSON.stringify(jqXHR) + '</div>';
                            promptMessage("Error message", tip);
                        }


                    });
                }, 5000);

            });

        });
    </script>
</head>

<body>
    <div id="mainContainer" style="margin-left:20px;">
        <div id="mainContent">
            <h2><a id="content" name="content">System - Flashing...</a></h2>
            <p id="status"></p>
            <p id="steps"></p>
            <fieldset class="cbi-section" id="upgrade_tip">
                <p>
                    The system is flashing now, this process will take several minutes.<br /> DO NOT POWER OFF THE DEVICE!<br /> Wait a few minutes before you try to reconnect. It might be necessary to renew the address of your computer to reach the device
                    again, depending on your settings.
                </p>
                <!-- <p>
                    <img src="images/loading.gif" alt="Loading" style="vertical-align:middle" /> Waiting for changes to be applied...
                </p> -->
            </fieldset>
        </div>
    </div>
</body>

</html>