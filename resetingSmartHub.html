<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap/3.3.7/bootstrap.min.css">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <link href="css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/myProgress.css" />
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap/3.3.7/bootstrap.min.js"></script>
    <script src="js/jquery.myProgress.js"></script>
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0
        }
        
        .Restart-factory-reset {
            font-family: OpenSans;
            font-size: 44px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.36;
            letter-spacing: normal;
            text-align: left;
            color: #861f41;
        }
        
        .Restarting-SmartHub {
            font-family: OpenSans;
            font-size: 22px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.18;
            letter-spacing: normal;
            text-align: left;
            color: #3a3a3a;
        }
        
        .Rectangle-1286 {
            border-radius: 12px;
            background-color: #fff;
        }
        
        .progress-in {
            height: 24px;
            margin: 0;
            padding: 0;
            border-radius: 12px !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid" style="margin:40px 70px;">
        <div class="row">
            <h3 style="margin-bottom:40px;" class="Restart-factory-reset">Factory Reset</h3>
            <div class="Restarting-SmartHub">Reseting SmartHub...</div>
            <div class="progress-out Rectangle-1286 mt-20" id="div3">
                <div class="percent-show"><span>0</span>%</div>
                <div class="progress-in"></div>
            </div>
        </div>
    </div>
    <script src="layui/layui.js " charset="utf-8 "></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script>
        var length = 20;
        var successFlag = false;
        var data;
        var timer = null;
        $(function() {
            reStartInit();
            $('#btn').click(function() {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index); //关闭当前页
            });
        })

        function reStartInit() {
            $("#div3").myProgress({
                speed: 6000,
                percent: length,
                width: "100%",
            });
            var timeout0 = 2000;
            data = {
                "jsonrpc": "2.0",
                "method": "RestartAndReset",
                "params": {
                    "mode": 1
                },
                "id": "1.1"
            }
            data = JSON.stringify(data);
            var ajaxTimeout = $.ajax({
                type: "post",
                url: "/action/action",
                timeout: timeout0,
                data: data,
                dataType: "json",
                contentType: "application/json",
                success: function(res) {
                    if (res.result && res.result.status == 2) {
                        successFlag = false;
                        PollingChecked();
                    } else if (res.result && res.result.status == 0) {
                        successFlag = 2;
                        $(".Restarting-SmartHub").text("Reset SmartHub Fail");
                        $("#div3").hide();
                    } else if (res.result && res.result.status == 1) {
                        successFlag = true;
                    } else if (res.error) {
                        successFlag = false;
                        $(".Restarting-SmartHub").text("Reset SmartHub Fail")
                        $("#div3").hide();
                        layui.use(['layer'], function() {
                            var layer = layui.layer;
                            layer.msg("An error occurred：" + res.error.message);
                        });
                    }
                },
                complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
                    if (status == 'timeout') { //超时,status还有success,error等值的情况
                        ajaxTimeout.abort();
                    }
                },
                error: function(jqXHR) {
                    console.log(jqXHR)
                    successFlag = false;
                    PollingChecked();
                    //var tip = '<div style="padding: 20px;text-align: center;word-wrap:break-word;">' + JSON.stringify(jqXHR) + '</div>';
                    //promptMessage("Error message", tip);
                }

            });
        }

        function PollingChecked() {
            clearInterval(timer);
            timer = setInterval(function() {
                if (successFlag == true) {
                    length = 100;
                    var domain = window.location.host;
                    $("#div3").myProgress({
                        speed: 0,
                        percent: 100,
                        width: "100%",
                    });

                    $(".Restarting-SmartHub").text("Restart SmartHub Successful")
                    $(".progress-out").css("border", "1px solid green");
                    $(".progress-in").css("background-color", "green");
                    $(".progress-in").css("background-image",
                        "-webkit-linear-gradient(top, green 0%, green 40%, green 100%)");
                    clearInterval(timer);
                    setTimeout(function() {
                        window.location.href = ('https:' == document.location.protocol ?
                            'https://' : 'http://') + domain + "/home.html";
                    }, 500);
                } else if (successFlag == 2) {

                } else {
                    if (length <= 60) {
                        length += 20;
                    }
                    $("#div3").myProgress({
                        speed: 6000,
                        percent: length,
                        width: "100%",
                    });
                    reStarting2(2);
                }
            }, 6000)
        }

        function reStarting2(flag) {
            console.log(1111111)
            var timeout0 = 3000;
            data = {
                "jsonrpc": "2.0",
                "method": "RestartAndReset",
                "params": {
                    "mode": 2
                },
                "id": "1.1"
            }
            data = JSON.stringify(data);
            var ajaxTimeout = $.ajax({
                type: "post",
                url: "/action/action",
                timeout: timeout0,
                data: data,
                dataType: "json",
                contentType: "application/json",
                success: function(res) {

                    if (res.result && res.result.status == 2) {
                        successFlag = false;
                    } else if (res.result && res.result.status == 0) {
                        successFlag = 2;
                        $(".Restarting-SmartHub").text("Reset SmartHub Fail");
                        $("#div3").hide();
                    } else if (res.result && res.result.status == 1) {
                        successFlag = true;
                    } else if (res.error) {
                        successFlag = false;
                        $(".Restarting-SmartHub").text("Reset SmartHub Fail")
                        $("#div3").hide();
                        layui.use(['layer'], function() {
                            var layer = layui.layer;
                            layer.msg("An error occurred：" + res.error.message);
                        });
                    }
                },
                complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
                    if (status == 'timeout') { //超时,status还有success,error等值的情况
                        ajaxTimeout.abort();
                    }
                },
                error: function(jqXHR) {
                    console.log(jqXHR)

                    //var tip = '<div style="padding: 20px;text-align: center;word-wrap:break-word;">' + JSON.stringify(jqXHR) + '</div>';
                    //promptMessage("Error message", tip);
                }

            });
        }
    </script>
</body>

</html>