<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> -->
    <title>文件上传</title>

    <link href="layui/css/layui.css" rel="stylesheet" />
    <link href="css/style.css?mv=20210225" rel="stylesheet" />
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/common.js?mv=20210225"></script>
    <script src="layui/layui.js" type="text/javascript"></script>
    <script src="js/upload.js?mv=20210225" type="text/javascript"></script>
    <style>
        .red {
            color: #861f41 !important
        }
        
        .layui-btn {
            display: inline-block;
            height: 38px;
            line-height: 38px;
            padding: 0 18px;
            background-color: #861f41 !important;
            color: #fff !important;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
        }
        
        .Software-upgrade {
            font-family: OpenSans;
            font-size: 44px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.36;
            letter-spacing: normal;
            text-align: left;
            color: #861f41;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .Rectangle-1182 {
            width: 221px;
            height: 54px;
            border-radius: 5px;
            background-color: #861f41;
        }
        
        .Browse-file-to-upload {
            font-family: OpenSans;
            font-size: 18px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.33;
            letter-spacing: normal;
            text-align: center;
            color: #ffffff;
        }
        
        .Rectangle-1183 {
            width: 126px;
            height: 54px;
            border-radius: 5px;
            background-color: #861f41;
        }
        
        .Upgrade {
            font-family: OpenSans;
            font-size: 18px;
            line-height: 54px;
            letter-spacing: normal;
            text-align: center;
            color: #ffffff;
        }
        
        .disable-btn {
            opacity: 0.54;
        }
        
        .upgrade-title {
            font-family: OpenSans;
            font-size: 22px;
            font-weight: 600;
            text-align: left;
            color: #333333;
            padding-left: 20px;
        }
        
        .exclamatory-mark {
            width: 33px;
            height: 32px;
        }
        
        .version-name {
            margin-bottom: 10px;
            opacity: 0.74;
            font-family: OpenSans;
            font-size: 14px;
            text-align: left;
            color: #333333;
        }
        
        .version-num {
            padding-left: 70px;
        }
    </style>
</head>

<body>
    <div class="container" style="margin:40px 80px;">
        <div class="row">
            <h2 class="col-md-12 Software-upgrade" style="margin-bottom:10px;">Software upgrade</h2>
        </div>
        <div class="row -flex-display -align-box mt-30">
            <img class="exclamatory-mark" src="images/tanhao.png" />
            <span class="upgrade-title">SmartHub software requires an update</span>
        </div>
        <div class="row mt-20">
            <div class="col-md-12 version-name">Application version:<span id="version" class="version-name version-num"></span></div>
            <div class="col-md-12 version-name">Platform version:<span id="Platform_version" class="version-name version-num"></span></div>
            <div class="col-md-12 version-name">Product bundle version:<span id="Product_version" class="version-name version-num"></span></div>
        </div>


        <div class="layui-form-mid layui-word-aux"></div>
        <form class="layui-form" method="post" action="javascript:;" enctype="multipart/form-data">

            <div class="layui-form-item">
                <!-- <label class="layui-form-label">图片上传</label> -->
                <div class="layui-inline">
                    <div class="layui-upload-drag" id="upload">
                        <i class="layui-icon red"></i>
                        <p>Drag file here or...</p>
                        <input type="button" class="layui-btn Rectangle-1182 Browse-file-to-upload mt-20" id="fileUpload" lay-submit value="Browse file to upload">
                    </div>
                </div>
                <div class="layui-inline" id="upload_preview"></div>
            </div>

            <div class="layui-form-item layui-hide" id="upload_progress">
                <!-- <label class="layui-form-label"></label> -->
                <div class="layui-input-inline" style="width:21%;">
                    <div class="layui-progress" lay-showpercent="true" lay-filter="upload_progress">
                        <div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>
                    </div>
                </div>
            </div>
            <div class="mt-30">
                <div class="layui-input-inline">
                    <div class="layui-btn Rectangle-1183 Upgrade disable-btn" id="upgrade">Upgrade</div>
                </div>
            </div>
        </form>
    </div>
</body>
<script>
    $(function() {
        getVersion();
        layui.use(['layer', 'element', 'form', 'upload'], function() {
            var layer = layui.layer,
                element = layui.element,
                form = layui.form;

            var box = document.querySelector('#upload');

            //只要鼠标拖拽悬停在该区域就会触发
            box.addEventListener('dragover', function(e) {
                e.preventDefault(); //注意，如果dragover不阻止默认事件，drop事件就不会触发
                console.log('dragover');
            }, false);
            //鼠标拖拽释放
            box.addEventListener('drop', function(e) {
                e.preventDefault(); //浏览器默认会打开该文件，因此停掉该默认事件
                console.log(e.dataTransfer.files); //选中的文件
                var files = e.dataTransfer.files;
                console.log(files)
                var formData = new FormData();

                Array.prototype.slice.call(files).forEach(function(file) {
                    formData.append('file', file);
                });

                var xhr = new XMLHttpRequest();
                xhr.upload.onerror = function() {
                    layer.msg("Upload fail！");
                }
                xhr.upload.onload = function() {
                    console.log('上传成功');
                }
                $("#upload_progress").removeClass("layui-hide");
                xhr.upload.onprogress = function(e) {
                    var value = Math.floor(100 * e.loaded / e.total);
                    element.progress('upload_progress', value + '%') //设置页面进度条
                    $("#upgrade").prop("disabled", true);
                }
                xhr.open('post', '/action/upload', true);
                xhr.send(formData);
                xhr.onreadystatechange = state_Change;

                function state_Change() {
                    if (xhr.readyState == 4) { // 4 = "loaded"
                        if (xhr.status == 200) { // 200 = OK
                            var resObj = JSON.parse(xhr.response)
                            if (resObj.code == 0) {
                                layer.msg("Upload successful！");
                                $("#upgrade").removeClass("disable-btn");
                                // var domain = window.location.host;
                                // setTimeout(function() {
                                //     window.location.href = ('https:' == document
                                //         .location.protocol ? 'https://' : 'http://'
                                //     ) + domain + "/flashops.html";
                                // }, 1000);
                                console.log(resObj)
                                $("#version").html(resObj.id);
                            } else {
                                layer.msg("Upload fail:" + msg);
                            }
                        } else {
                            layer.msg("Upload fail！");
                        }
                    }
                }
            }, false);
        })
    })

    function getVersion() {
        var data = {
            "jsonrpc": "2.0",
            "method": "GetHubInfo",
            "params": {

            },
            "id": "9.1"
        };

        data = JSON.stringify(data);
        $.ajax({
            type: "post",
            url: "/action/action",
            data: data,
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function(res) {
                if (res.result) {
                    $("#version").html(res.result.TotalVersion);
                } else if (res.error) {
                    layui.use(['form', 'layer'], function() {
                        var layer = layui.layer;
                        layer.msg("An error occurred：" + res.error.message);
                    })
                }
            },
            error: function(jqXHR) {
                var tip = '<div style="padding: 20px;text-align: center;word-wrap:break-word;">' + JSON
                    .stringify(jqXHR) + '</div>';
                promptMessage("Error message", tip);
            }
        });
    }
</script>

</html>