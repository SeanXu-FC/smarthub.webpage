<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link href="layui/css/layui.css" rel="stylesheet" />
    <link href="css/style.css?mv=20210323" rel="stylesheet" />
    <title>Document</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        .lan {
            position: relative;
            width: 600px;
        }
        
        .lanBt {
            font-weight: bold;
            font-size: 18px;
        }
        /* .lan-content {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            position: relative;
        } */
        
        .lan-h {
            font-weight: bold;
            font-size: 16px;
        }
        
        .lan-edit {
            position: absolute;
            width: 30px;
            height: 20px;
            top: 48px;
            right: 45px;
            padding-right: 20px;
            vertical-align: middle;
        }
        
        .edit-first {
            position: absolute;
            top: 107px;
            right: 45px;
        }
        
        .lan-edit a {
            color: #007de9
        }
        
        .Channels-configuration {
            font-family: OpenSans;
            font-size: 44px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.36;
            letter-spacing: normal;
            text-align: left;
            color: #861f41;
            border-bottom: solid 1px #ddd;
            padding-bottom: 10px;
        }
        
        .Inputs {
            font-family: OpenSans;
            font-size: 28px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.36;
            letter-spacing: normal;
            text-align: left;
            color: #000000;
        }
        
        .Rectangle-1234 {
            /* width: 378px; */
            height: 128px;
            border-radius: 10px;
            border: solid 1px #707070;
            padding: 10px;
        }
        
        .Edit {
            font-family: OpenSans;
            font-size: 20px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.35;
            letter-spacing: normal;
            text-align: left;
            color: #007de9;
            vertical-align: middle;
        }
        
        .Bilge-pump {
            font-family: OpenSans;
            font-size: 24px;
            font-weight: 600;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.38;
            letter-spacing: normal;
            text-align: left;
            color: #000000;
            max-width: 88%;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .Channel {
            font-family: OpenSans;
            font-size: 20px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.35;
            letter-spacing: normal;
            text-align: left;
            color: #000000;
        }
        
        .Digital-input {
            font-family: OpenSans;
            font-size: 16px;
            font-weight: normal;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.38;
            letter-spacing: normal;
            text-align: left;
            color: #666666;
            cursor: pointer
        }
        
        .text-green {
            color: #26b167;
        }
        
        .layui-layer-btn a.layui-layer-btn0 {
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container-fluid" style="padding:30px 70px;">
        <h3 class="Channels-configuration">Alert notifications</h3>
        <input style="display: none" id="saved_id" name="saved_id" />
        <div class="mt-40">
            <div class="lan">
                <div class="mt-20 Rectangle-1234 inputsEdit" dataId="1">
                    <p class="lan-h Bilge-pump" id="name1">--</p>
                    <p class="mt-10 Channel">Channel 1 </p>
                    <p class="Digital-input mt-10 mytooltip" id="Notifications1">Notifications --</p>
                    <span class="lan-edit Edit "><a href="#">Edit</a></span>
                </div>

            </div>

            <div class="lan mt-10">
                <div class="mt-20 Rectangle-1234 inputsEdit" dataId="2">
                    <p class="lan-h Bilge-pump" id="name2">--</p>
                    <p class="mt-10 Channel">Channel 2 </p>
                    <p class="Digital-input mt-10 mytooltip" id="Notifications2">Notifications --</p>
                    <span class="lan-edit Edit "><a href="#">Edit</a></span>
                </div>
            </div>

            <div class="lan mt-10">
                <div class="mt-20 Rectangle-1234 inputsEdit" dataId="3">
                    <p class="lan-h Bilge-pump" id="name3">--</p>
                    <p class="mt-10 Channel">Channel 3 </p>
                    <p class="Digital-input mt-10 mytooltip" id="Notifications3">Notifications --</p>
                    <span class="lan-edit Edit "><a href="#">Edit</a></span>
                </div>
            </div>

            <div class="lan mt-10">
                <div class="mt-20 Rectangle-1234 inputsEdit" dataId="4">
                    <p class="lan-h Bilge-pump" id="name4">--</p>
                    <p class="mt-10 Channel">Channel 4 </p>
                    <p class="Digital-input mt-10 mytooltip" id="Notifications4">Notifications --</p>
                    <span class="lan-edit Edit "><a href="#">Edit</a></span>
                </div>
            </div>

        </div>
    </div>
    <script src="layui/layui.js " charset="utf-8 "></script>
    <script type="text/javascript" src="js/common.js?mv=20210323"></script>
    <script>
        var frequency = 0;
        $(function() {
            layui.use('layer', function() {
                var layer = layui.layer;
                var loading = layer.load(0, {
                    shade: false
                });
                getMonitoringData(layer, loading);
            });
            //弹出一个iframe层
            $('.inputsEdit').on('click', function() {
                var dataId = $(this).attr("dataId");
                var name = $(this).children(".Bilge-pump").text();
                var Notifications = $(this).children(".Digital-input").attr("Notifications");
                var trigType = $(this).children(".Digital-input").attr("trigType");
                var volt = $(this).children(".Digital-input").attr("volt");
                var noti_msg = $(this).children(".Digital-input").attr("noti_msg");
                noti_msg = "'" + noti_msg + "'";
                console.log(noti_msg)
                var types = $(this).children(".Digital-input").attr("types");
                //iframe层
                parent.layer.open({
                    type: 2,
                    title: false,
                    closeBtn: 0,
                    //shadeClose: true,
                    shade: 0.8,
                    area: ['761px', '450px'],
                    content: ['editNotifications.html?dataId=' + dataId + '&name=' + name +
                        '&Notifications=' + Notifications + '&trigType=' + trigType +
                        '&volt=' + volt + '&types=' + types, 'no'
                    ],
                    end: function() {
                        var ChannelID = $("#saved_id").val();
                        console.log(ChannelID)
                        if (ChannelID) {
                            location.reload();
                        }
                    }
                });
            });

        })

        function getMonitoringData(layer, loading) {

            var data = {
                "jsonrpc": "2.0",
                "method": "IoConfigure",
                "params": {
                    "mode": "0",
                },
                "id": "9.1"
            }
            data = JSON.stringify(data);
            $.ajax({
                type: "post",
                url: "/action/action",
                data: data,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function(res) {
                    layer.close(loading);
                    if (res.result && res.result.io_date) {
                        var json = res.result.io_date;

                        for (var i = 0; i < json.length; i++) {
                            if (i < 4) {
                                $("#name" + (i + 1)).text(json[i].name);
                                $("#Notifications" + (i + 1)).attr("Notifications", json[i].notification);
                                $("#Notifications" + (i + 1)).attr("trigType", json[i].trig_cond_type);
                                $("#Notifications" + (i + 1)).attr("volt", json[i].trig_cond_value);
                                $("#Notifications" + (i + 1)).attr("noti_msg", json[i].noti_msg);
                                $("#Notifications" + (i + 1)).attr("types", json[i].types);
                                if (json[i].notification == 0) {
                                    $("#Notifications" + (i + 1)).text("Notifications disabled");
                                    $("#Notifications" + (i + 1)).removeClass("text-green")
                                } else {
                                    $("#Notifications" + (i + 1)).text("Notifications enabled");
                                    $("#Notifications" + (i + 1)).addClass("text-green")
                                }
                                var titleStr = "";
                                if (json[i].notification == 1) {
                                    titleStr += "Alert trigger condition: Value above, " + json[i].volt +
                                        "v" + "\n";
                                } else {
                                    titleStr += "Alert trigger condition: Value below, " + json[i].volt +
                                        "v" + "\n";
                                }
                                titleStr += "Notification message: " + json[i].noti_msg + "\n";
                                if (json[i].wake_func == 1) {
                                    titleStr += "Wake function: ON";
                                } else {
                                    titleStr += "Wake function: OFF";
                                }

                                $("#Notifications" + (i + 1)).attr("title", titleStr)

                            }
                        }


                    } else if (res.error) {
                        layui.use(['form', 'layer'], function() {
                            var layer = layui.layer;
                            layer.msg("An error occurred：" + res.error.message);
                        })
                    }

                },
                error: function(jqXHR) {
                    console.log("Error message", JSON.stringify(jqXHR));
                    frequency++;
                    if (frequency < 3) {
                        setTimeout(() => {
                            getMonitoringData(layer, loading);
                        }, 5000);
                    } else {
                        frequency = 0;
                        layer.close(loading);
                        var tip =
                            '<div style="padding: 20px;text-align: center;word-wrap:break-word;">Abnormal communication!</div>';
                        promptMessage("Error message", tip);
                    }
                }
            })
        }

        $(".layui-layer").css("background", "none");
    </script>
</body>

</html>